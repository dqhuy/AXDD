version: '3.8'

services:
  # ============================================================================
  # Infrastructure Services
  # ============================================================================

  # SQL Server - Main Business Database
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: axdd-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrong@Passw0rd
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - axdd-network
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "YourStrong@Passw0rd" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s

  # PostgreSQL + PostGIS - GIS Database
  postgres-gis:
    image: postgis/postgis:16-3.4-alpine
    container_name: axdd-postgres-gis
    environment:
      - POSTGRES_DB=gisdb
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - axdd-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: axdd-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - axdd-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    command: redis-server --appendonly yes

  # RabbitMQ Message Queue
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: axdd-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - axdd-network
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO S3-Compatible Storage
  minio:
    image: minio/minio:latest
    container_name: axdd-minio
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports:
      - "9000:9000"   # API port
      - "9001:9001"   # Console port
    volumes:
      - minio-data:/data
    networks:
      - axdd-network
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # Elasticsearch Full-Text Search
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: axdd-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - axdd-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ============================================================================
  # Microservices - API Layer
  # ============================================================================

  # API Gateway
  api-gateway:
    build:
      context: .
      dockerfile: src/ApiGateway/AXDD.ApiGateway/Dockerfile
    container_name: axdd-api-gateway
    ports:
      - "5000:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Services__AuthService=http://auth-api:8080
      - Services__MasterDataService=http://masterdata-api:8080
      - Services__EnterpriseService=http://enterprise-api:8080
      - Services__InvestmentService=http://investment-api:8080
      - Services__FileManagerService=http://filemanager-api:8080
      - Services__ReportService=http://report-api:8080
      - Services__NotificationService=http://notification-api:8080
      - Services__LoggingService=http://logging-api:8080
      - Services__SearchService=http://search-api:8080
      - Services__GISService=http://gis-api:8080
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      auth-api:
        condition: service_started
      masterdata-api:
        condition: service_started
      enterprise-api:
        condition: service_started
      investment-api:
        condition: service_started
      filemanager-api:
        condition: service_started
      report-api:
        condition: service_started
      notification-api:
        condition: service_started
      logging-api:
        condition: service_started
      search-api:
        condition: service_started
      gis-api:
        condition: service_started
    networks:
      - axdd-network

  # Auth Service
  auth-api:
    build:
      context: .
      dockerfile: src/Services/Auth/AXDD.Services.Auth.Api/Dockerfile
    container_name: axdd-auth-api
    ports:
      - "5001:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=AuthDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;
      - Redis__Configuration=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - axdd-network

  # MasterData Service
  masterdata-api:
    build:
      context: .
      dockerfile: src/Services/MasterData/AXDD.Services.MasterData.Api/Dockerfile
    container_name: axdd-masterdata-api
    ports:
      - "5002:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=MasterDataDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;
      - Redis__Configuration=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - axdd-network

  # Enterprise Service
  enterprise-api:
    build:
      context: .
      dockerfile: src/Services/Enterprise/AXDD.Services.Enterprise.Api/Dockerfile
    container_name: axdd-enterprise-api
    ports:
      - "5003:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=EnterpriseDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;
      - Redis__Configuration=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - axdd-network

  # Investment Service
  investment-api:
    build:
      context: .
      dockerfile: src/Services/Investment/AXDD.Services.Investment.Api/Dockerfile
    container_name: axdd-investment-api
    ports:
      - "5004:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=InvestmentDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;
      - Redis__Configuration=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - axdd-network

  # FileManager Service
  filemanager-api:
    build:
      context: .
      dockerfile: src/Services/FileManager/AXDD.Services.FileManager.Api/Dockerfile
    container_name: axdd-filemanager-api
    ports:
      - "5005:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=FileMetaDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;
      - MinIO__Endpoint=minio:9000
      - MinIO__AccessKey=minioadmin
      - MinIO__SecretKey=minioadmin
      - MinIO__UseSSL=false
      - Redis__Configuration=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - axdd-network

  # Report Service
  report-api:
    build:
      context: .
      dockerfile: src/Services/Report/AXDD.Services.Report.Api/Dockerfile
    container_name: axdd-report-api
    ports:
      - "5006:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=ReportDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;
      - Redis__Configuration=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - axdd-network

  # Notification Service
  notification-api:
    build:
      context: .
      dockerfile: src/Services/Notification/AXDD.Services.Notification.Api/Dockerfile
    container_name: axdd-notification-api
    ports:
      - "5007:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=NotificationDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;
      - Redis__Configuration=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - axdd-network

  # Logging Service
  logging-api:
    build:
      context: .
      dockerfile: src/Services/Logging/AXDD.Services.Logging.Api/Dockerfile
    container_name: axdd-logging-api
    ports:
      - "5008:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=LoggingDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;
      - Redis__Configuration=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - axdd-network

  # Search Service
  search-api:
    build:
      context: .
      dockerfile: src/Services/Search/AXDD.Services.Search.Api/Dockerfile
    container_name: axdd-search-api
    ports:
      - "5009:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Elasticsearch__Url=http://elasticsearch:9200
      - Redis__Configuration=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    networks:
      - axdd-network

  # GIS Service
  gis-api:
    build:
      context: .
      dockerfile: src/Services/GIS/AXDD.Services.GIS.Api/Dockerfile
    container_name: axdd-gis-api
    ports:
      - "5010:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__GISConnection=Host=postgres-gis;Port=5432;Database=gisdb;Username=postgres;Password=postgres;
      - Redis__Configuration=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=admin
      - RabbitMQ__Password=admin
    depends_on:
      postgres-gis:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - axdd-network

  # ============================================================================
  # Web Applications
  # ============================================================================

  # Admin Web App (MVC)
  admin-webapp:
    build:
      context: .
      dockerfile: src/WebApps/AXDD.WebApp.Admin/Dockerfile
    container_name: axdd-admin-webapp
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ApiGateway__Url=http://api-gateway:8080
      - Authentication__Authority=http://auth-api:8080
    depends_on:
      - api-gateway
      - auth-api
    networks:
      - axdd-network

  # Enterprise Portal (Angular)
  enterprise-portal:
    build:
      context: ./src/WebApps/EnterprisePortal
      dockerfile: Dockerfile
    container_name: axdd-enterprise-portal
    ports:
      - "4200:80"
    depends_on:
      - api-gateway
    networks:
      - axdd-network

# ============================================================================
# Networks
# ============================================================================
networks:
  axdd-network:
    driver: bridge

# ============================================================================
# Volumes for Data Persistence
# ============================================================================
volumes:
  sqlserver-data:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local
  rabbitmq-data:
    driver: local
  minio-data:
    driver: local
  elasticsearch-data:
    driver: local
