@model AXDD.WebApp.Admin.Models.ViewModels.NotificationListViewModel
@{
    ViewData["Title"] = "Notifications";
}

@section Breadcrumb {
    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
    <li class="breadcrumb-item active">Notifications</li>
}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-bell mr-2"></i>
                    Notification Center
                    @if (Model.UnreadCount > 0)
                    {
                        <span class="badge badge-danger ml-2">@Model.UnreadCount unread</span>
                    }
                </h3>
                <div class="card-tools">
                    @if (Model.UnreadCount > 0)
                    {
                        <button type="button" class="btn btn-primary btn-sm" id="markAllReadBtn">
                            <i class="fas fa-check-double"></i> Mark All as Read
                        </button>
                    }
                </div>
            </div>
            
            <div class="card-body">
                @if (Model.Notifications.Any())
                {
                    <!-- Timeline -->
                    <div class="timeline">
                        @foreach (var notification in Model.Notifications)
                        {
                            <!-- Timeline time label -->
                            @if (notification == Model.Notifications.First() || 
                                 notification.CreatedAt.Date != Model.Notifications[Model.Notifications.IndexOf(notification) - 1].CreatedAt.Date)
                            {
                                <div class="time-label">
                                    <span class="bg-gray">
                                        @if (notification.CreatedAt.Date == DateTime.Today)
                                        {
                                            <text>Today</text>
                                        }
                                        else if (notification.CreatedAt.Date == DateTime.Today.AddDays(-1))
                                        {
                                            <text>Yesterday</text>
                                        }
                                        else
                                        {
                                            @notification.CreatedAt.ToString("MMMM dd, yyyy")
                                        }
                                    </span>
                                </div>
                            }
                            
                            <!-- Timeline item -->
                            <div>
                                <i class="@notification.Icon @GetBackgroundClass(notification.Type)"></i>
                                <div class="timeline-item @(notification.IsRead ? "" : "notification-unread")">
                                    <span class="time">
                                        <i class="fas fa-clock"></i> @GetRelativeTime(notification.CreatedAt)
                                    </span>
                                    <h3 class="timeline-header">
                                        @if (!notification.IsRead)
                                        {
                                            <span class="badge badge-warning mr-2">New</span>
                                        }
                                        <strong class="@notification.ColorClass">@notification.Title</strong>
                                    </h3>
                                    <div class="timeline-body">
                                        @notification.Message
                                    </div>
                                    <div class="timeline-footer">
                                        @if (!string.IsNullOrEmpty(notification.ActionUrl))
                                        {
                                            <a href="@notification.ActionUrl" class="btn btn-primary btn-sm">
                                                <i class="fas fa-external-link-alt"></i> View Details
                                            </a>
                                        }
                                        @if (!notification.IsRead)
                                        {
                                            <button type="button" class="btn btn-success btn-sm mark-read-btn" data-id="@notification.Id">
                                                <i class="fas fa-check"></i> Mark as Read
                                            </button>
                                        }
                                        <button type="button" class="btn btn-danger btn-sm delete-notification-btn" data-id="@notification.Id">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                        
                        <!-- End timeline -->
                        <div>
                            <i class="fas fa-clock bg-gray"></i>
                        </div>
                    </div>
                    
                    <!-- Pagination -->
                    @if (Model.TotalPages > 1)
                    {
                        <div class="row mt-4">
                            <div class="col-sm-12 col-md-5">
                                <div class="dataTables_info">
                                    Showing @((Model.PageNumber - 1) * Model.PageSize + 1) 
                                    to @(Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount)) 
                                    of @Model.TotalCount notifications
                                </div>
                            </div>
                            <div class="col-sm-12 col-md-7">
                                <ul class="pagination float-right">
                                    <!-- Previous Page -->
                                    <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                                        <a class="page-link" href="@Url.Action("Index", new { pageNumber = Model.PageNumber - 1, pageSize = Model.PageSize })">
                                            <i class="fas fa-angle-left"></i>
                                        </a>
                                    </li>
                                    
                                    <!-- Page Numbers -->
                                    @for (int i = Math.Max(1, Model.PageNumber - 2); i <= Math.Min(Model.TotalPages, Model.PageNumber + 2); i++)
                                    {
                                        <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                            <a class="page-link" href="@Url.Action("Index", new { pageNumber = i, pageSize = Model.PageSize })">@i</a>
                                        </li>
                                    }
                                    
                                    <!-- Next Page -->
                                    <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : "")">
                                        <a class="page-link" href="@Url.Action("Index", new { pageNumber = Model.PageNumber + 1, pageSize = Model.PageSize })">
                                            <i class="fas fa-angle-right"></i>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-bell-slash fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No Notifications</h4>
                        <p class="text-muted">You don't have any notifications at the moment.</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Mark single notification as read
            $('.mark-read-btn').on('click', function() {
                var button = $(this);
                var notificationId = button.data('id');
                
                $.ajax({
                    url: '@Url.Action("MarkAsRead", "Notification")',
                    type: 'POST',
                    data: { id: notificationId },
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            // Remove the button
                            button.remove();
                            // Remove the "New" badge
                            button.closest('.timeline-item').find('.badge-warning').remove();
                            // Remove unread styling
                            button.closest('.timeline-item').removeClass('notification-unread');
                            // Update unread count
                            updateUnreadCount(-1);
                            
                            // Show success message
                            toastr.success('Notification marked as read');
                        }
                    },
                    error: function() {
                        toastr.error('Failed to mark notification as read');
                    }
                });
            });
            
            // Mark all notifications as read
            $('#markAllReadBtn').on('click', function() {
                if (!confirm('Are you sure you want to mark all notifications as read?')) {
                    return;
                }
                
                $.ajax({
                    url: '@Url.Action("MarkAllAsRead", "Notification")',
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            // Reload the page to show updated notifications
                            location.reload();
                        }
                    },
                    error: function() {
                        toastr.error('Failed to mark all notifications as read');
                    }
                });
            });
            
            // Delete notification
            $('.delete-notification-btn').on('click', function() {
                var button = $(this);
                var notificationId = button.data('id');
                
                if (!confirm('Are you sure you want to delete this notification?')) {
                    return;
                }
                
                $.ajax({
                    url: '@Url.Action("Delete", "Notification")',
                    type: 'POST',
                    data: { id: notificationId },
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            // Remove the timeline item
                            button.closest('.timeline-item').parent().fadeOut(300, function() {
                                $(this).remove();
                                // Check if page is empty
                                if ($('.timeline-item').length === 0) {
                                    location.reload();
                                }
                            });
                            
                            // Update unread count if notification was unread
                            if (!button.closest('.timeline-item').hasClass('notification-unread')) {
                                updateUnreadCount(-1);
                            }
                            
                            // Show success message
                            toastr.success('Notification deleted successfully');
                        }
                    },
                    error: function() {
                        toastr.error('Failed to delete notification');
                    }
                });
            });
            
            // Helper function to update unread count
            function updateUnreadCount(change) {
                var badge = $('.card-title .badge-danger');
                if (badge.length > 0) {
                    var currentCount = parseInt(badge.text().match(/\d+/)[0]);
                    var newCount = currentCount + change;
                    
                    if (newCount <= 0) {
                        badge.parent().remove();
                        $('#markAllReadBtn').remove();
                    } else {
                        badge.text(newCount + ' unread');
                    }
                }
            }
        });
    </script>
    
    <style>
        /* Unread notification styling */
        .notification-unread {
            background-color: #f8f9fa;
            border-left: 3px solid #007bff;
        }
        
        /* Timeline customization */
        .timeline > div > .timeline-item {
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .timeline > div > .timeline-item > .time {
            color: #999;
            font-size: 12px;
            padding: 5px 10px;
        }
        
        .timeline > div > .timeline-item > .timeline-header {
            border-bottom: 1px solid #f4f4f4;
            padding: 10px;
            font-size: 16px;
            line-height: 1.1;
            margin: 0;
        }
        
        .timeline > div > .timeline-item > .timeline-body {
            padding: 10px;
            color: #555;
        }
        
        .timeline > div > .timeline-item > .timeline-footer {
            border-top: 1px solid #f4f4f4;
            padding: 10px;
            background-color: #f8f9fa;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }
        
        .timeline > div > .timeline-item > .timeline-footer > .btn {
            margin-right: 5px;
        }
    </style>
}

@functions {
    private string GetBackgroundClass(string type)
    {
        return type switch
        {
            "Info" => "bg-info",
            "Warning" => "bg-warning",
            "Error" => "bg-danger",
            "Success" => "bg-success",
            _ => "bg-secondary"
        };
    }
    
    private string GetRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;
        
        if (timeSpan.TotalSeconds < 60)
            return "just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} minute{((int)timeSpan.TotalMinutes != 1 ? "s" : "")} ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} hour{((int)timeSpan.TotalHours != 1 ? "s" : "")} ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays} day{((int)timeSpan.TotalDays != 1 ? "s" : "")} ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)(timeSpan.TotalDays / 7)} week{((int)(timeSpan.TotalDays / 7) != 1 ? "s" : "")} ago";
        if (timeSpan.TotalDays < 365)
            return $"{(int)(timeSpan.TotalDays / 30)} month{((int)(timeSpan.TotalDays / 30) != 1 ? "s" : "")} ago";
        
        return $"{(int)(timeSpan.TotalDays / 365)} year{((int)(timeSpan.TotalDays / 365) != 1 ? "s" : "")} ago";
    }
}
